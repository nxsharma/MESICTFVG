//best so far for 1 minute
//@version=5
strategy("ICT Displacement + FVG Auto Trend/Reversal (MES)", overlay=true, initial_capital=10000, currency=currency.USD)

// ===== INPUTS =====
useSilverBullet = input.bool(true, "Only Trade Silver Bullet Hour (10-11 AM)")
maxTradesPerDay = input.int(1, "Max Trades Per Day")
rrRatio         = input.float(2.0, "Risk:Reward Ratio")

// ===== SESSION & DAILY LIMIT =====
is_new_day = ta.change(time("D"))
var int daily_trade_count = 0
if is_new_day
    daily_trade_count := 0

sessionRange = useSilverBullet ? "1000-1100" : "0930-1600"
inSession = not na(time(timeframe.period, sessionRange, "America/New_York"))

// ===== DISPLACEMENT & BIAS =====
bodySize = math.abs(close - open)
avgBody = ta.sma(bodySize, 20)
// Higher threshold (2.0) for "High Probability" displacement
isDisplaced = bodySize > avgBody * 2.0 

var int marketBias = 0 
var int lastDispBar = 0

if isDisplaced and inSession
    marketBias := close > open ? 1 : -1
    lastDispBar := bar_index

// ===== FVG DETECTION =====
// We only look for a tap AFTER the displacement candle has finished
bullFVG = marketBias == 1 and low > high[2] and bar_index > lastDispBar
bearFVG = marketBias == -1 and high < low[2] and bar_index > lastDispBar

// ===== ENTRY CONDITIONS =====
// 1. Must be in session
// 2. Haven't reached daily limit
// 3. No open position
// 4. Must be at least 1 bar after the displacement
canEnter = inSession and daily_trade_count < maxTradesPerDay and strategy.position_size == 0 and bar_index > lastDispBar

longCondition  = canEnter and bullFVG 
shortCondition = canEnter and bearFVG 

// ===== EXECUTION =====
if longCondition
    sl = low[2]
    tp = close + (math.abs(close - sl) * rrRatio)
    strategy.entry("ICT Long", strategy.long)
    strategy.exit("Exit Long", "ICT Long", stop=sl, limit=tp)
    daily_trade_count += 1
    marketBias := 0 // Reset bias after entry
    alert("ICT LONG: High Prob Setup", alert.freq_once_per_bar)

if shortCondition
    sl = high[2]
    tp = close - (math.abs(close - sl) * rrRatio)
    strategy.entry("ICT Short", strategy.short)
    strategy.exit("Exit Short", "ICT Short", stop=sl, limit=tp)
    daily_trade_count += 1
    marketBias := 0 // Reset bias after entry
    alert("ICT SHORT: High Prob Setup", alert.freq_once_per_bar)

// ===== VISUALS =====
bgcolor(inSession ? color.new(color.blue, 96) : na)
plotshape(longCondition, "Long", shape.labelup, location.belowbar, color.lime, size=size.small, text="BULLISH", textcolor=color.black)
plotshape(shortCondition, "Short", shape.labeldown, location.abovebar, color.red, size=size.small, text="BEARISH", textcolor=color.white)
